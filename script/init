#!/usr/bin/env bash

cp .env.dev.sample .env.dev

docker-compose build

docker-compose run --rm rails rails new . --force --database=postgresql --skip-bundle --skip-git --skip-test -m https://gist.githubusercontent.com/masashi-fuji/26e4f31397e39193dbf002a8b714ea38/raw/slim-rails.rb

mv Gemfile bak.Gemfile
touch Gemfile
echo ruby \'2.4.1\' >> Gemfile
echo >> Gemfile
cat bak.Gemfile >> Gemfile
rm bak.Gemfile

sed -i '' "s/# gem \'therubyracer\'/gem \'therubyracer\'/g" Gemfile

docker-compose run --rm rails bundle update

cp -f template/database.yml config/database.yml

docker-compose run --rm rails bundle exec spring binstub --all
docker-compose run --rm rails erb2slim app/views app/views -d

rm -rf .git
git init
git add .
git commit -m "init"
